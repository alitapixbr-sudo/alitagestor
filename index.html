<div class="footer" aria-label="Créditos do criador">
    <span class="creator">Criado por: Felippe - CEO <span class="brand">Alita Play</span></span>
  </div>
</div>
<div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-content">
    <h2 id="modalTitle">Adicionar Cliente</h2>
    <form id="modalForm" autocomplete="off">
      <input type="text" id="modalName" placeholder="Nome" required aria-required="true" />
      <input type="text" id="modalApp" placeholder="Aplicativo" required aria-required="true" />
      <input type="text" id="modalMac" placeholder="MAC" maxlength="17" required aria-required="true" />
      <input type="tel" id="modalPhone" placeholder="Telefone" required aria-required="true" />
      <input type="text" id="modalServers" placeholder="Servidores" required aria-required="true" />
      <input type="number" id="modalValue" placeholder="Valor (R$)" min="0" step="0.01" required aria-required="true" />
      <input type="date" id="modalExpiration" required aria-required="true" />
      <input type="number" id="modalScreens" placeholder="Número de telas" min="1" required aria-required="true" />
      <div class="modal-actions">
        <button type="button" id="cancelBtn">Cancelar</button>
        <button type="submit">Salvar</button>
      </div>
    </form>
  </div>
</div>

<div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
  <div class="modal-content">
    <h2 id="confirmModalTitle" style="color:#dc3545;">Confirmar Exclusão</h2>
    <p style="text-align:center; margin-bottom: 30px; font-size:1.1em;">
      Você tem certeza que deseja remover o cliente 
      <strong id="clientNameToDelete" style="color:white;">[Nome do Cliente]</strong>?
    </p>
    <div class="modal-actions" style="justify-content: space-around; margin-top:0;">
      <button type="button" id="cancelDeleteBtn">Cancelar</button>
      <button type="button" id="confirmDeleteBtn" class="btn-remove" style="background: #dc3545; color: white;">Confirmar</button>
    </div>
  </div>
</div>
<script>
  // ------------------------------------
  // CONFIGURAÇÕES E ELEMENTOS
  // ------------------------------------
  const ACCESS_CODE = 'AlitaCeo12';

  const body = document.body;
  const loginScreen = document.getElementById('login-screen');
  const dashboardContent = document.getElementById('dashboard-content');
  const loginForm = document.getElementById('loginForm');
  const accessCodeInput = document.getElementById('accessCode');
  const loginError = document.getElementById('loginError');

  // NOVOS ELEMENTOS
  const deviceSelectionScreen = document.getElementById('device-selection-screen');
  const accessComputerBtn = document.getElementById('accessComputer');
  const accessMobileBtn = document.getElementById('accessMobile');
  // FIM DOS NOVOS ELEMENTOS

  const clients = [];
  const tbody = document.getElementById('clientTableBody');
  const modal = document.getElementById('modal');
  const modalForm = document.getElementById('modalForm');
  const modalTitle = document.getElementById('modalTitle');
  const btnAdd = document.getElementById('btnAdd');
  const cancelBtn = document.getElementById('cancelBtn');
  const searchInput = document.getElementById('search');
  const filterStatus = document.getElementById('filterStatus');
  const filterExpiration = document.getElementById('filterExpiration');
  const clearFilters = document.getElementById('clearFilters');
  const totalClientsElem = document.getElementById('totalClients');
  const activeClientsElem = document.getElementById('activeClients');
  const nearExpireClientsElem = document.getElementById('nearExpireClients');
  const expiredClientsElem = document.getElementById('expiredClients');

  // ELEMENTOS DO NOVO MODAL DE CONFIRMAÇÃO
  const confirmModal = document.getElementById('confirmModal');
  const clientNameToDeleteElem = document.getElementById('clientNameToDelete');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
  let clientIndexToDelete = null; // Variável para armazenar o índice do cliente a ser excluído

  let editIndex = null;

  // ------------------------------------
  // FUNÇÕES DE EXIBIÇÃO
  // ------------------------------------

  function showDeviceSelection() {
      loginScreen.style.display = 'none';
      deviceSelectionScreen.style.display = 'flex';
  }

  function loadDashboard(deviceType) {
      deviceSelectionScreen.style.display = 'none';
      dashboardContent.style.display = 'block';

      // Aplica estilo para simular resolução mobile, se necessário
      if (deviceType === 'mobile') {
          body.classList.add('force-mobile-view');
      } else {
          body.classList.remove('force-mobile-view');
      }

      // Salva o tipo de dispositivo e o status de login na sessão
      sessionStorage.setItem('isLoggedIn', 'true');
      sessionStorage.setItem('deviceType', deviceType);

      loadClients();
  }

  function checkLogin() {
      const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
      const deviceType = sessionStorage.getItem('deviceType');

      if (isLoggedIn && deviceType) {
          // Já fez login e escolheu o dispositivo: carrega o dashboard
          loadDashboard(deviceType);
      } else if (isLoggedIn) {
          // Fez login, mas não escolheu o dispositivo: mostra a tela de seleção
          showDeviceSelection();
      } else {
          // Não logado: mostra a tela de login
          loginScreen.style.display = 'flex';
          dashboardContent.style.display = 'none';
      }
  }

  // ------------------------------------
  // LISTENERS DE LOGIN E SELEÇÃO
  // ------------------------------------

  loginForm.addEventListener('submit', e => {
      e.preventDefault();
      const code = accessCodeInput.value.trim();

      if (code === ACCESS_CODE) {
          // Código correto: armazena status de login e vai para a seleção de dispositivo
          sessionStorage.setItem('isLoggedIn', 'true');
          showDeviceSelection();
      } else {
          // Código incorreto: mostra mensagem de erro
          loginError.textContent = 'Código de acesso inválido.';
          accessCodeInput.value = '';
          accessCodeInput.focus();
      }
  });

  accessComputerBtn.addEventListener('click', () => {
      loadDashboard('computer');
  });

  accessMobileBtn.addEventListener('click', () => {
      loadDashboard('mobile');
  });

  // ------------------------------------
  // FUNÇÕES DO DASHBOARD (Restante do Código)
  // ------------------------------------

  function getStatus(client) {
    const today = new Date();
    // Adiciona 'T00:00:00' para evitar problemas de fuso horário na comparação
    const vencimento = new Date(client.expiration + 'T00:00:00'); 
    const diffTime = vencimento - today;
    const diffDays = diffTime / (1000 * 60 * 60 * 24);
    if(diffDays < 0) return "vencido";
    else if(diffDays <= 5) return "proximo";
    else return "ativo";
  }

  function renderTable() {
    tbody.innerHTML = '';

    // Atualiza painéis resumo
    totalClientsElem.textContent = clients.length;
    let countAtivo = 0;
    let countProximo = 0;
    let countVencido = 0;
    clients.forEach(c => {
      const st = getStatus(c);
      if(st==="ativo") countAtivo++;
      else if(st==="proximo") countProximo++;
      else countVencido++;
    });
    activeClientsElem.textContent = countAtivo;
    nearExpireClientsElem.textContent = countProximo;
    expiredClientsElem.textContent = countVencido;

    // Filtrar clientes conforme busca e filtros
    let filtered = clients.filter(c => {
      const searchValue = searchInput.value.toLowerCase();
      let status = getStatus(c);

      let matchesSearch = c.name.toLowerCase().includes(searchValue) ||
                          c.app.toLowerCase().includes(searchValue) ||
                          c.mac.toLowerCase().includes(searchValue);

      let matchesStatus = true;
      if(filterStatus.value){
        matchesStatus = (filterStatus.value === status);
      }

      let matchesExpiration = true;
      if(filterExpiration.value){
        matchesExpiration = c.expiration === filterExpiration.value;
      }
      return matchesSearch && matchesStatus && matchesExpiration;
    });

    if(filtered.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="10" style="text-align:center; padding:15px;">Nenhum cliente encontrado.</td>`;
      tbody.appendChild(tr);
      return;
    }

    // Nota: O índice 'i' aqui é o índice no array 'filtered',
    // mas precisamos do índice no array 'clients' (original) para a remoção.
    // Como a sua função removeClient original não lidava com a filtragem de forma ideal,
    // estou mudando o `onclick` para passar o índice do *cliente* dentro do array `clients`.

    // CUIDADO: Este loop abaixo está usando o 'i' do array *filtrado*.
    // A chamada `onclick="openModal(${i})"` e `onclick="removeClient(${i})"`
    // usa o índice do `filtered` array, não do `clients` array, o que
    // causaria um erro se o array estivesse filtrado.

    // SOLUÇÃO: Vamos encontrar o índice real no array `clients` para a ação.
    filtered.forEach((c, i) => {
      let st = getStatus(c);
      let statusText = st.charAt(0).toUpperCase()+st.slice(1);
      let statusClass = `status-${st}`;
      const tr = document.createElement('tr');
      
      // Encontrar o índice real do cliente no array `clients`
      const clientIndex = clients.findIndex(client => client.mac === c.mac && client.name === c.name);

      tr.innerHTML = `
        <td>${escapeHtml(c.name)}</td>
        <td>${escapeHtml(c.app)}</td>
        <td>${escapeHtml(c.mac)}</td>
        <td>${escapeHtml(c.phone)}</td>
        <td>${escapeHtml(c.servers)}</td>
        <td>${Number(c.value).toFixed(2)}</td>
        <td>${formatDate(c.expiration)}</td>
        <td>${escapeHtml(c.screens)}</td>
        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        <td>
          <button class="btn btn-edit" onclick="openModal(${clientIndex})">Editar</button>
          <button class="btn btn-remove" onclick="openConfirmModal(${clientIndex})">Remover</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function formatDate(dateStr){
    const d = new Date(dateStr + 'T00:00:00'); // Garante que a data seja interpretada corretamente
    const day = ("0" + d.getDate()).slice(-2);
    const month = ("0" + (d.getMonth()+1)).slice(-2);
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
  }

  function escapeHtml(text){
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function openModal(index=null){
    closeConfirmModal(); // Garante que o modal de confirmação esteja fechado
    modal.style.display = 'flex';
    if(index === null){
      modalTitle.textContent = 'Adicionar Cliente';
      modalForm.reset();
      editIndex = null;
    } else {
      modalTitle.textContent = 'Editar Cliente';
      const c = clients[index];
      modalForm.modalName.value = c.name;
      modalForm.modalApp.value = c.app;
      modalForm.modalMac.value = c.mac;
      modalForm.modalPhone.value = c.phone;
      modalForm.modalServers.value = c.servers;
      modalForm.modalValue.value = c.value;
      modalForm.modalExpiration.value = c.expiration;
      modalForm.modalScreens.value = c.screens || '';
      editIndex = index;
    }
  }

  function closeModal(){
    modal.style.display = 'none';
  }
  
  // NOVA FUNÇÃO: ABRE O MODAL DE CONFIRMAÇÃO
  function openConfirmModal(index){
    const client = clients[index];
    if (client) {
      clientIndexToDelete = index;
      clientNameToDeleteElem.textContent = client.name;
      confirmModal.style.display = 'flex';
    }
  }

  // NOVA FUNÇÃO: FECHA O MODAL DE CONFIRMAÇÃO
  function closeConfirmModal(){
    confirmModal.style.display = 'none';
    clientIndexToDelete = null;
  }

  // FUNÇÃO DE REMOÇÃO (Chamada após a confirmação)
  function removeClient(){
    if(clientIndexToDelete !== null){
      clients.splice(clientIndexToDelete, 1);
      saveClients();
      renderTable();
      closeConfirmModal();
    }
  }

  function saveClients(){
    localStorage.setItem('clients', JSON.stringify(clients));
  }

  function loadClients(){
    const saved = localStorage.getItem('clients');
    if(saved){
      const parsed = JSON.parse(saved);
      clients.splice(0, clients.length, ...parsed);
    }
    renderTable();
  }

  function formatMac(value) {
    return value
      .replace(/[^a-fA-F0-9]/g, '')
      .substring(0,12)
      .replace(/(.{2})(?=.)/g, '$1:')
      .toLowerCase();
  }
  const macInput = document.getElementById('modalMac');
  macInput.addEventListener('input', function() {
    let cursorPosition = this.selectionStart;
    let oldValue = this.value;
    let formatted = formatMac(oldValue);

    this.value = formatted;

    if (formatted.length > oldValue.length && (cursorPosition === 3 || cursorPosition === 6 || cursorPosition === 9 || cursorPosition === 12)) {
      cursorPosition += 1;
    }
    this.selectionEnd = this.selectionStart = cursorPosition;
  });


  // LISTENERS ATUALIZADOS
  btnAdd.addEventListener('click', () => openModal());
  cancelBtn.addEventListener('click', () => closeModal());
  searchInput.addEventListener('input', () => renderTable());
  filterStatus.addEventListener('change', () => renderTable());
  filterExpiration.addEventListener('change', () => renderTable());
  clearFilters.addEventListener('click', () => {
    searchInput.value = '';
    filterStatus.value = '';
    filterExpiration.value = '';
    renderTable();
  });

  // LISTENERS DO NOVO MODAL
  confirmDeleteBtn.addEventListener('click', () => removeClient()); // Remove e fecha
  cancelDeleteBtn.addEventListener('click', () => closeConfirmModal()); // Apenas fecha

  modalForm.addEventListener('submit', e => {
    e.preventDefault();
    const newClient = {
      name: modalForm.modalName.value.trim(),
      app: modalForm.modalApp.value.trim(),
      mac: modalForm.modalMac.value.trim(),
      phone: modalForm.modalPhone.value.trim(),
      servers: modalForm.modalServers.value.trim(),
      value: parseFloat(modalForm.modalValue.value).toFixed(2),
      expiration: modalForm.modalExpiration.value,
      screens: modalForm.modalScreens.value.trim()
    };
    if(editIndex === null){
      clients.push(newClient);
    } else {
      clients[editIndex] = newClient;
    }
    saveClients();
    renderTable();
    closeModal();
  });

  window.addEventListener('click', e => {
    if(e.target === modal) closeModal();
    if(e.target === confirmModal) closeConfirmModal(); // Adiciona fechamento ao clicar fora do novo modal
  });

  // Chama a função de verificação de login ao carregar a página
  checkLogin();
</script>
</body>
</html>
